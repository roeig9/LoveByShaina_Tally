<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Radius Selector Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Editable -->
  <script src="https://unpkg.com/leaflet-editable@1.2.0/src/Leaflet.Editable.js"></script>

  <style>
    body, html {
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: Arial;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .info-box {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }
    #submitBtn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 12px 22px;
      background-color: #0066ff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<div class="info-box">
  Move the circle or drag its edge.<br>
  Radius (meters): <span id="radiusValue">Loading…</span>
</div>

<button id="submitBtn">Use this location</button>

<div id="map"></div>

<script>
  // YOUR TALLY FORM URL
  const TALLY_FORM_URL = "https://tally.so/r/NpqWgj";

  // Initialize map
  var map = L.map('map', { editable: true }).setView([0, 0], 13);

  // Tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);

  var circle;

  map.locate({ setView: true, maxZoom: 15 });

  map.on("locationfound", function (e) {
    var lat = e.latlng.lat;
    var lng = e.latlng.lng;

    circle = L.circle([lat, lng], {
      radius: 1000,
      editable: true
    }).addTo(map);

    circle.enableEdit();

    map.fitBounds(circle.getBounds());

    document.getElementById("radiusValue").innerText = 
  Math.round(circle.getRadius() / 1000) + " km";


    // Update displayed radius
circle.on("editable:vertex:drag editable:drag", function () {
  document.getElementById("radiusValue").innerText = 
    Math.round(circle.getRadius() / 1000) + " km";
});

  });

    async function getCityName(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`;
    const res = await fetch(url, { headers: { "User-Agent": "yourapp" } });
    const data = await res.json();
    return data.address.city || data.address.town || data.address.village || "Unknown";
  }

    document.getElementById("submitBtn").addEventListener("click", async function () {
    if (!circle) return alert("Map is still loading…");

    const center = circle.getLatLng();
    const radius = circle.getRadius();

    const city = await getCityName(center.lat, center.lng);

    document.getElementById("map").style.display = "none";
    document.getElementById("submitBtn").style.display = "none";

    const box = document.querySelector(".info-box");
    box.innerHTML = `
      <b>Location Selected</b><br>
      City: ${city}<br>
      Radius: ${Math.round(radius / 1000)} km<br><br>
    `;

    const url =
      `${TALLY_FORM_URL}?lat=${center.lat}&lng=${center.lng}&radius=${radius}&city=${encodeURIComponent(city)}`;

    setTimeout(() => {
      window.location.href = url;
    }, 2000);
  });

  map.on("locationerror", function () {
    alert("Could not get your location. Please allow location permissions.");
  });
</script>

